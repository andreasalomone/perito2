name: PeritoAI Supply Chain Orchestration

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write # Required for WIF

env:
  PROJECT_ID: perito-479708
  PROJECT_NUMBER: 738291935960
  REGION: europe-west1
  ARTIFACT_REGISTRY: europe-west1-docker.pkg.dev
  BACKEND_SERVICE: robotperizia-backend
  FRONTEND_SERVICE: robotperizia-frontend
  WIF_PROVIDER: projects/738291935960/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  WIF_SERVICE_ACCOUNT: robotperizia-sa@perito-479708.iam.gserviceaccount.com

jobs:
  # JOB 1: Smart Change Detection
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'shared/**'
              - '.github/workflows/**'
            frontend:
              - 'frontend/**'
              - 'shared/**'

  # JOB 2: Backend Delivery (Build ‚Üí Migrate ‚Üí Deploy)
  backend-delivery:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # FIX 1: Build with SHA tag, then tag 'latest' separately
      - name: Build Backend Container
        run: |
          gcloud builds submit backend \
            --region ${{ env.REGION }} \
            --tag ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/backend:${{ github.sha }} \
            --timeout=20m

      - name: Tag Backend as Latest
        run: |
          gcloud artifacts docker tags add \
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/backend:${{ github.sha }} \
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/backend:latest

      # Security Gate: Vulnerability Scanning
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/backend:${{ github.sha }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
        env:
          TRIVY_USERNAME: oauth2accesstoken
          TRIVY_PASSWORD: ${{ steps.auth.outputs.access_token }}

      # Database Migrations (Robust Logic)
      - name: Run Database Migrations
        run: |
          # Variable for repeated flags to ensure consistency
          JOB_FLAGS="--image ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/backend:${{ github.sha }} \
            --set-cloudsql-instances perito-479708:europe-west1:robotperizia-db \
            --set-env-vars DB_USER=report_user,DB_NAME=perizia_db,GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},CLOUD_SQL_CONNECTION_NAME=perito-479708:europe-west1:robotperizia-db,STORAGE_BUCKET_NAME=robotperizia-uploads-roberto,CLOUD_TASKS_QUEUE_PATH=projects/${{ env.PROJECT_ID }}/locations/${{ env.REGION }}/queues/report-processing-queue,BACKEND_URL=https://api.perito.my \
            --set-secrets DB_PASS=database-password:latest,GEMINI_API_KEY=gemini-api-key:latest,CLOUD_TASKS_SA_EMAIL=cloud-tasks-sa-email:latest,SUPERADMIN_EMAILS=SUPERADMIN_EMAILS:latest \
            --region ${{ env.REGION }} \
            --max-retries 3 \
            --task-timeout 10m"

          # Idempotent Create or Update
          if gcloud run jobs describe migrate-db-job --region ${{ env.REGION }} > /dev/null 2>&1; then
            echo "Updating existing migration job..."
            gcloud run jobs update migrate-db-job $JOB_FLAGS
          else
            echo "Creating new migration job..."
            gcloud run jobs create migrate-db-job --command python --args="-m,alembic,upgrade,head" $JOB_FLAGS
          fi
          
          # Block deployment if migration fails
          gcloud run jobs execute migrate-db-job --wait --region ${{ env.REGION }}

      # Deploy with canary strategy (0% traffic initially)
      - name: Deploy Backend to Cloud Run (Canary)
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          image: ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/backend:${{ github.sha }}
          region: ${{ env.REGION }}
          tag: green  # Deploy to 'green' revision tag
          no_traffic: true  # Don't route traffic yet
          timeout: 720s  # 12 min: LLM (600s) + processing buffer (120s) - prevents timeout dead zone
          env_vars: |
            GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}
            GOOGLE_CLOUD_REGION=${{ env.REGION }}
            CLOUD_SQL_CONNECTION_NAME=perito-479708:europe-west1:robotperizia-db
            DB_USER=report_user
            DB_NAME=perizia_db
            STORAGE_BUCKET_NAME=robotperizia-uploads-roberto
            CLOUD_TASKS_QUEUE_PATH=projects/${{ env.PROJECT_ID }}/locations/${{ env.REGION }}/queues/report-processing-queue
            BACKEND_URL=https://api.perito.my
          secrets: |
            /secrets/service-account.json=firebase-creds:latest
            DB_PASS=database-password:latest
            GEMINI_API_KEY=gemini-api-key:latest
            CLOUD_TASKS_SA_EMAIL=cloud-tasks-sa-email:latest
            SUPERADMIN_EMAILS=SUPERADMIN_EMAILS:latest

      # FIX 2: Get the exact Canary URL directly from Cloud Run API (No sed hacking)
      - name: Verify Canary Health
        run: |
          echo "üîç Retrieving Canary URL..."
          
          # This filter asks Cloud Run: "Look at traffic tags, find the one named 'green', give me its URL"
          CANARY_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} \
            --region ${{ env.REGION }} \
            --format json | jq -r '.status.traffic[] | select(.tag=="green") | .url')
          
          if [ -z "$CANARY_URL" ]; then
            echo "‚ùå Could not find a URL for tag 'green'. Deployment might have failed."
            exit 1
          fi

          echo "üß™ Smoke Testing Canary at: $CANARY_URL/health"
          
          # Retry loop
          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$CANARY_URL/health")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Canary is healthy (HTTP 200)!"
              exit 0
            fi
            echo "‚è≥ Attempt $i: Got HTTP $HTTP_CODE. Retrying in 5s..."
            sleep 5
          done
          
          echo "‚ùå Canary health check failed with HTTP $HTTP_CODE"
          exit 1

      # Promotion (Safe Route)
      - name: Promote Canary to 100%
        run: |
          echo "üöÄ Smoke test passed. Routing 100% traffic to the new revision (LATEST)."
          gcloud run services update-traffic ${{ env.BACKEND_SERVICE }} \
            --region ${{ env.REGION }} \
            --to-latest

  # JOB 3: Frontend Delivery
  frontend-delivery:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build Frontend with Cloud Build
        run: |
          gcloud builds submit frontend \
            --region ${{ env.REGION }} \
            --tag ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/frontend:${{ github.sha }} \
            --timeout=20m

      # Explicitly tag latest for frontend too
      - name: Tag Frontend as Latest
        run: |
          gcloud artifacts docker tags add \
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/frontend:${{ github.sha }} \
            ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/frontend:latest

      - name: Deploy Frontend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE }}
          image: ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/app/frontend:${{ github.sha }}
          region: ${{ env.REGION }}
          env_vars: |
            NEXT_PUBLIC_API_URL=https://api.perito.my
          secrets: |
            FIREBASE_API_KEY=next-public-firebase-api-key:latest
            FIREBASE_AUTH_DOMAIN=next-public-firebase-auth-domain:latest
            FIREBASE_PROJECT_ID=next-public-firebase-project-id:latest
            FIREBASE_STORAGE_BUCKET=next-public-firebase-storage-bucket:latest
            FIREBASE_MESSAGING_SENDER_ID=next-public-firebase-messaging-sender-id:latest
            FIREBASE_APP_ID=next-public-firebase-app-id:latest
            FIREBASE_MEASUREMENT_ID=next-public-firebase-measurement-id:latest