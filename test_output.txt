============================= test session starts ==============================
platform darwin -- Python 3.13.3, pytest-9.0.1, pluggy-1.6.0 -- /Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/.venv/bin/python3.13
cachedir: .pytest_cache
rootdir: /Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito
plugins: anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 2 items

backend/tests/logic_audit_verification.py::test_extraction_persists_attachments_to_gcs DEBUG: sys.path: ['/Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/backend', '/Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/.venv/bin', '/Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito', '/Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/backend', '/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python313.zip', '/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13', '/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/lib-dynload', '/Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/.venv/lib/python3.13/site-packages']
DEBUG: process_document_extraction file: /Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/backend/app/services/case_service.py
DEBUG: case_service modules: ['app.services.case_service']
DEBUG: process_document_extraction called for doc doc_123. Found doc: <MagicMock name='mock.query().filter().first()' id='4646460048'>
DEBUG: Downloading gs://bucket/email.eml to /var/folders/8h/kd63qyq11mld3hzfp9sq5f2r0000gn/T/tmp31s3q4wq/extract_doc_123_email.eml
DEBUG: download_file_to_temp is <MagicMock id='4646462064'>
DEBUG: processed data: [{'type': 'text', 'content': 'Email body'}, {'type': 'vision', 'path': '/tmp/random_dir/attachment.jpg', 'filename': 'attachment.jpg'}]
DEBUG: Skipping item: None (local_path=/var/folders/8h/kd63qyq11mld3hzfp9sq5f2r0000gn/T/tmp31s3q4wq/extract_doc_123_email.eml, exists=N/A)
PASSED
backend/tests/logic_audit_verification.py::test_generation_uses_item_gcs_path_if_present DEBUG: generate_report_logic file: /Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/backend/app/services/report_generation_service.py
DEBUG: generate_report_logic called for case case_1
DEBUG: Found case <MagicMock name='mock.query().filter().with_for_update().first().id' id='4911401008'>
FAILED

=================================== FAILURES ===================================
________________ test_generation_uses_item_gcs_path_if_present _________________

    @pytest.mark.asyncio
    async def test_generation_uses_item_gcs_path_if_present():
        """
        Verifies that report generation prefers item_gcs_path over doc.gcs_path
        when re-downloading assets.
        """
        from app.services.report_generation_service import generate_report_logic
        print(f"DEBUG: generate_report_logic file: {generate_report_logic.__code__.co_filename}")
    
        mock_db = MagicMock()
        mock_doc = MagicMock()
        mock_doc.id = "doc_123"
        mock_doc.ai_status = "processed"
        mock_doc.gcs_path = "gs://bucket/original.pdf"
    
        # Data has a specific artifact path
        mock_doc.ai_extracted_data = [{
            "type": "vision",
            "path": "/old/path/img.jpg",
            "item_gcs_path": "gs://bucket/artifact.jpg",
            "filename": "img.jpg"
        }]
    
        # Setup Query mocks
        mock_case = MagicMock()
        mock_case.status = "open"
        mock_db.query.return_value.filter.return_value.with_for_update.return_value.first.return_value = mock_case
        mock_db.query.return_value.filter.return_value.all.return_value = [mock_doc]
    
        import app.services.report_generation_service
        # Manual Patching for Generation
        original_download = generate_report_logic.__globals__["download_file_to_temp"]
        original_llm = generate_report_logic.__globals__["llm_handler"]
    
        mock_download = MagicMock()
        mock_llm = MagicMock()
    
        generate_report_logic.__globals__["download_file_to_temp"] = mock_download
        generate_report_logic.__globals__["llm_handler"] = mock_llm
    
        try:
             mock_llm.generate_report_from_content.return_value = ("Report", {})
    
             # Patch other dependencies via patch context if they are not direct globals or if easier
             with patch("app.services.report_generation_service.docx_generator"), \
                  patch("app.services.report_generation_service.get_storage_client"), \
                  patch("app.services.report_generation_service.download_semaphore", new=asyncio.Semaphore(5)):
    
                 await generate_report_logic("case_1", "org_1", mock_db)
    
                 # ASSERTION: Should download the ARTIFACT path, not the ORIGINAL path
>                mock_download.assert_called_with("gs://bucket/artifact.jpg", ANY)

backend/tests/logic_audit_verification.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock id='4911403696'>, args = ('gs://bucket/artifact.jpg', <ANY>)
kwargs = {}, expected = "mock('gs://bucket/artifact.jpg', <ANY>)"
actual = 'not called.'
error_message = "expected call not found.\nExpected: mock('gs://bucket/artifact.jpg', <ANY>)\n  Actual: not called."

    def assert_called_with(self, /, *args, **kwargs):
        """assert that the last call was made with the specified arguments.
    
        Raises an AssertionError if the args and keyword args passed in are
        different to the last call to the mock."""
        if self.call_args is None:
            expected = self._format_mock_call_signature(args, kwargs)
            actual = 'not called.'
            error_message = ('expected call not found.\nExpected: %s\n  Actual: %s'
                    % (expected, actual))
>           raise AssertionError(error_message)
E           AssertionError: expected call not found.
E           Expected: mock('gs://bucket/artifact.jpg', <ANY>)
E             Actual: not called.

/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:970: AssertionError
=============================== warnings summary ===============================
backend/app/core/config.py:5
  /Users/andreasalomone/perito-wrap/robotperizia/report-ai-v2/perito/backend/app/core/config.py:5: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

<frozen importlib._bootstrap>:488
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:488
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type swigvarlink has no __module__ attribute

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED backend/tests/logic_audit_verification.py::test_generation_uses_item_gcs_path_if_present - AssertionError: expected call not found.
Expected: mock('gs://bucket/artifact.jpg', <ANY>)
  Actual: not called.
=================== 1 failed, 1 passed, 6 warnings in 2.35s ====================
