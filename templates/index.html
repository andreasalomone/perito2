{% extends "base_layout.html" %}

{% block content %}
<div class="container">
    <h1>AI Insurance Report Generator</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flash-messages">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <!-- Error Container (Hidden initially) -->
    <div id="error-container" style="display: none; margin-bottom: 1.5rem;">
        <div class="flash-messages">
            <li class="error" id="error-message-text"></li>
        </div>
    </div>

    <!-- Upload Section -->
    <div id="upload-section">
        <form id="uploadForm" action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data">
            <label for="fileInput" class="file-upload-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-upload-cloud">
                    <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path>
                    <path d="M12 12v9"></path>
                    <path d="m16 16-4-4-4 4"></path>
                </svg>
                <span>Clicca per selezionare i files o trascinali qui</span>
                <span style="font-size: 0.875rem; color: #94a3b8;">PDF, Immagini (JPG, PNG), Excel</span>
            </label>
            <input type="file" name="files" id="fileInput" multiple hidden>

            <div id="file-list-container">
                <!-- Selected files will be listed here by JS -->
            </div>

            <button type="submit" id="generateBtn" disabled>Genera Perizia</button>
        </form>
    </div>

    <!-- Stepper Section (Hidden initially) -->
    <div id="stepper-section" style="display: none;">
        <div class="card">
            <h2>Generazione in corso...</h2>
            <p style="color: var(--text-muted);">L'intelligenza artificiale sta analizzando i tuoi documenti.</p>

            <div class="stepper">
                <div class="step" id="step-1">
                    <div class="step-icon">1</div>
                    <div class="step-content">
                        <div class="step-title">Caricamento & OCR</div>
                        <div class="step-desc" style="font-size: 0.875rem;">Estrazione testo dai documenti</div>
                    </div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-icon">2</div>
                    <div class="step-content">
                        <div class="step-title">Analisi Strutturale</div>
                        <div class="step-desc" style="font-size: 0.875rem;">Identificazione dati chiave</div>
                    </div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-icon">3</div>
                    <div class="step-content">
                        <div class="step-title">Stesura Report</div>
                        <div class="step-desc" style="font-size: 0.875rem;">Generazione contenuti con AI</div>
                    </div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-icon">4</div>
                    <div class="step-content">
                        <div class="step-title">Finalizzazione</div>
                        <div class="step-desc" style="font-size: 0.875rem;">Formattazione documento Word</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('file-list-container');
        const uploadLabel = document.querySelector('.file-upload-label');
        const generateBtn = document.getElementById('generateBtn');
        const uploadSection = document.getElementById('upload-section');
        const stepperSection = document.getElementById('stepper-section');
        const errorContainer = document.getElementById('error-container');
        const errorMessageText = document.getElementById('error-message-text');

        // Add a container for real-time logs
        const logContainer = document.createElement('div');
        logContainer.id = 'realtime-logs';
        logContainer.style.marginTop = '1rem';
        logContainer.style.padding = '1rem';
        logContainer.style.backgroundColor = '#f8fafc';
        logContainer.style.borderRadius = '0.5rem';
        logContainer.style.border = '1px solid #e2e8f0';
        logContainer.style.maxHeight = '200px';
        logContainer.style.overflowY = 'auto';
        logContainer.style.fontFamily = 'monospace';
        logContainer.style.fontSize = '0.875rem';
        logContainer.style.color = '#475569';
        logContainer.style.display = 'none'; // Hidden initially

        // Insert log container after stepper
        const stepperDiv = document.querySelector('.stepper');
        stepperDiv.parentNode.insertBefore(logContainer, stepperDiv.nextSibling);

        let dataTransfer = new DataTransfer();

        // --- File Handling ---

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'ðŸ–¼ï¸';
            if (['pdf'].includes(ext)) return 'ðŸ“•';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'ðŸ“Š';
            return 'ðŸ“„';
        }

        function renderFileList() {
            fileListContainer.innerHTML = '';

            if (dataTransfer.files.length > 0) {
                generateBtn.disabled = false;
                generateBtn.textContent = `Genera Perizia (${dataTransfer.files.length} files)`;
            } else {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Genera Perizia';
            }

            Array.from(dataTransfer.files).forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                const fileDetails = document.createElement('div');
                fileDetails.className = 'file-details';

                const icon = document.createElement('span');
                icon.className = 'file-icon';
                icon.textContent = getFileIcon(file.name);

                const infoDiv = document.createElement('div');

                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;

                const fileSize = document.createElement('div');
                fileSize.className = 'file-size';
                const sizeKB = file.size / 1024;
                fileSize.textContent = sizeKB > 1024 ? `(${(sizeKB / 1024).toFixed(2)} MB)` : `(${sizeKB.toFixed(1)} KB)`;

                infoDiv.appendChild(fileName);
                infoDiv.appendChild(fileSize);

                fileDetails.appendChild(icon);
                fileDetails.appendChild(infoDiv);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-file-btn';
                removeBtn.textContent = 'Ã—';
                removeBtn.type = 'button';
                removeBtn.title = 'Rimuovi file';

                removeBtn.addEventListener('click', () => {
                    const newFiles = new DataTransfer();
                    Array.from(dataTransfer.files)
                        .filter((_, i) => i !== index)
                        .forEach(f => newFiles.items.add(f));

                    dataTransfer = newFiles;
                    renderFileList();
                });

                fileItem.appendChild(fileDetails);
                fileItem.appendChild(removeBtn);
                fileListContainer.appendChild(fileItem);
            });
        }

        function handleFiles(files) {
            for (const file of files) {
                const isDuplicate = Array.from(dataTransfer.files).some(
                    f => f.name === file.name && f.size === file.size
                );
                if (!isDuplicate) {
                    dataTransfer.items.add(file);
                }
            }
            renderFileList();
        }

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
            fileInput.value = '';
        });

        uploadLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadLabel.classList.add('drag-over');
        });

        uploadLabel.addEventListener('dragleave', () => {
            uploadLabel.classList.remove('drag-over');
        });

        uploadLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadLabel.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        // --- Stepper Logic ---

        function updateStepper(stepName) {
            // Map step names to IDs
            // stepName can be: 'queued', 'processing', 'generating', 'completed'
            // We map these to our 4 visual steps

            const stepMap = {
                'queued': 1,
                'processing': 2, // Covers extraction, analysis
                'generating': 3, // LLM generation
                'completed': 4
            };

            let activeStepNum = stepMap[stepName] || 1;

            // If we are in 'processing', we might want to be more granular if we had more steps,
            // but for now let's stick to the 4 visual steps.

            const steps = [
                { id: 'step-1', num: 1 },
                { id: 'step-2', num: 2 },
                { id: 'step-3', num: 3 },
                { id: 'step-4', num: 4 }
            ];

            steps.forEach(step => {
                const el = document.getElementById(step.id);
                if (activeStepNum > step.num) {
                    el.classList.remove('active');
                    el.classList.add('completed');
                } else if (activeStepNum === step.num) {
                    el.classList.add('active');
                    el.classList.remove('completed');
                } else {
                    el.classList.remove('active', 'completed');
                }
            });
        }

        function updateLogs(logs) {
            if (!logs || logs.length === 0) return;

            logContainer.style.display = 'block';
            logContainer.innerHTML = ''; // Clear and rebuild (simple approach)

            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '0.25rem';

                const timeSpan = document.createElement('span');
                timeSpan.style.color = '#94a3b8';
                timeSpan.style.marginRight = '0.5rem';
                // Format timestamp HH:MM:SS
                try {
                    const date = new Date(log.timestamp);
                    timeSpan.textContent = date.toLocaleTimeString([], { hour12: false });
                } catch (e) {
                    timeSpan.textContent = '';
                }

                const msgSpan = document.createElement('span');
                msgSpan.textContent = log.message;

                logEntry.appendChild(timeSpan);
                logEntry.appendChild(msgSpan);
                logContainer.appendChild(logEntry);
            });

            // Auto-scroll to bottom
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showError(message) {
            errorMessageText.textContent = message;
            errorContainer.style.display = 'block';
            // Scroll to error
            errorContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function hideError() {
            errorContainer.style.display = 'none';
        }

        // --- Form Submission ---

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            hideError();

            if (dataTransfer.files.length === 0) {
                showError('Per favore, seleziona almeno un file.');
                return;
            }

            // Switch UI
            uploadSection.style.display = 'none';
            stepperSection.style.display = 'block';
            logContainer.innerHTML = ''; // Clear previous logs
            logContainer.style.display = 'none';

            // Initialize stepper
            updateStepper('queued');

            const formData = new FormData();
            for (const file of dataTransfer.files) {
                formData.append('files', file);
            }

            fetch(form.action, {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (response.ok) return response.json();
                    return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                })
                .then(data => {
                    if (data.report_id) {
                        pollStatus(data.report_id);
                    } else {
                        throw new Error('No report ID returned');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);

                    // Reset UI
                    uploadSection.style.display = 'block';
                    stepperSection.style.display = 'none';

                    showError('Errore: ' + error.message);
                });
        });

        function pollStatus(reportId) {
            const pollInterval = setInterval(() => {
                fetch(`/report/status/${reportId}`)
                    .then(res => res.json())
                    .then(statusData => {
                        // Update Logs
                        if (statusData.progress_logs) {
                            updateLogs(statusData.progress_logs);
                        }

                        // Update Stepper based on current_step
                        if (statusData.current_step) {
                            updateStepper(statusData.current_step);
                        }

                        if (statusData.status === 'success') {
                            clearInterval(pollInterval);
                            // Force step 4 completion visual
                            updateStepper('completed');
                            setTimeout(() => {
                                window.location.href = `/report/${reportId}`;
                            }, 1000);
                        } else if (statusData.status === 'error') {
                            clearInterval(pollInterval);

                            uploadSection.style.display = 'block';
                            stepperSection.style.display = 'none';

                            showError('Errore durante la generazione: ' + (statusData.error || 'Errore sconosciuto'));
                        }
                    })
                    .catch(err => {
                        console.error('Polling error:', err);
                        // Don't stop polling immediately on network error
                    });
            }, 1000); // Poll every 1 second for better responsiveness
        }
    });
</script>
{% endblock %}